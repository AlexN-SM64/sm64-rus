# Инструкция по выполнению сборки

## Выполнение сборки игры для ПК (Windows, Linux)

Есть 5 шагов, чтобы выполнить совершенную рабочую сборку русифицированной игры для ПК!

### Шаг 1 - Установка пакетов

К системе сборки предъявляются следующие требования к пакету:

Windows (MSYS2 MinGW):

* python3 >= 3.6
* mingw-w64-gcc <= 13.2

Linux:

* python3 >= 3.6
* gcc, g++ <= 13.2
* pkgconf
* libusb-1.0
* SDL2
* bsdextrautils

Инструкции по установке пакетов приведены ниже:

#### Windows - MSYS2 MinGW

Для того, чтобы приступить, вам необходимо установить и обновить [MSYS2](https://msys2.org). Потом перед установкой пакетов не забудьте запустить ТОЛЬКО MSYS2 MinGW.

Важно: Запуск MSYS2 требуется Windows 8.1 или новее для систем x64. После запуска сначала обновите терминал и пакеты, введя `pacman -Syu`. Потом не забудьте перезапустить заново и ввести ещё раз до окончания обновления.

1. Установите базовые пакеты:
```
pacman -S git patch make python3
```

2. Установите необходимый GCC 13.2:
* В MSYS2 MinGW 64-бит:
```
pacman -U \
https://repo.msys2.org/mingw/mingw64/mingw-w64-x86_64-gcc-13.2.0-6-any.pkg.tar.zst \
https://repo.msys2.org/mingw/mingw64/mingw-w64-x86_64-gcc-libs-13.2.0-6-any.pkg.tar.zst
```
* В MSYS2 MinGW 32-бит:
```
pacman -U \
https://repo.msys2.org/mingw/mingw32/mingw-w64-i686-gcc-13.2.0-6-any.pkg.tar.zst \
https://repo.msys2.org/mingw/mingw32/mingw-w64-i686-gcc-libs-13.2.0-6-any.pkg.tar.zst
```

Важно: НЕ обновляйте GCC до версии 14 - выполнение сборки инструмента ARMIPS выдаёт ошибки. Для обновления других пакетов используйте `pacman -Syu --ignore mingw-w64-x86_64-gcc --ignore mingw-w64-x86_64-gcc-libs --ignore mingw-w64-i686-gcc --ignore mingw-w64-i686-gcc-libs`

#### Linux - Debian / Ubuntu

Установите пакеты:
```
sudo apt install git build-essential libusb-1.0-0-dev libsdl2-dev bsdextrautils
```

Важно: перед установкой пакетов не забудьте обновить список пакетов, введя `sudo apt update`.

#### Linux - Arch Linux

1. Установите пакеты:
```
sudo pacman -S base-devel python sdl2
```

Важно: перед установкой пакетов не забудьте обновить пакеты, введя `sudo pacman -Syu`.

2. Понизьте версию GCC до 13.2:
```
sudo pacman -U \
https://archive.archlinux.org/packages/g/gcc/gcc-13.2.1-6-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/g/gcc-libs/gcc-libs-13.2.1-6-x86_64.pkg.tar.zst
```

Важно: НЕ обновляйте GCC до версии 14 - выполнение сборки инструмента ARMIPS выдаёт ошибки. Для обновления других пакетов используйте `pacman -Syu --ignore gcc --ignore gcc-libs`

#### Linux - Другие дистрибутивы

Большинство современных дистрибутивов Linux должны иметь пакеты, эквивалентные двум другим, перечисленным выше.

Вы также можете использовать [Docker](#выполнение-сборки-игры-для-linux-с-помощью-docker) для установки образа с минимальными пакетами.

### Шаг 2 - Клонирование репозиторий

1. Клонируйте основной репозиторий, где есть исходный код игры:
```
git clone https://github.com/sm64-port/sm64-port
```

2. Клонируйте дополнительный репозиторий, где есть русификация:
```
git clone https://github.com/AlexN-SM64/sm64-rus
```

### Шаг 3 - Копирование в базовый РОМ для извлечения ассетов

Поставьте ТОЛЬКО оригинальную американскую (США) версию игры Super Mario 64 N64 ROM сюда и переименуйте в `baserom.us.z64` для извлечения ассетов.

Примечание: Этот базовый ROM должен совпадать SHA1: `9bef1128717f958171a4afac3ed78ee2bb4e86ce`. Наберите `sha1sum baserom.us.z64 && cat sm64.us.sha1` в строке терминала и проверьте, подходит ли для извлечения ассетов или нет.

### Шаг 4 - Русификация

1. В проводнике находите каталог `sm64-rus`, скопируйте всё, кроме папки `.git`, и вставляйте в тот каталог репозитория, где есть исходный код игры, заменив файлы.

2. Измените `Makefile` с помощью патча:
```
tools/apply_patch.sh patch_makefile_rus_diff3.patch
```

3. Выполните сборку контента:
```
bash build_content.sh
```

### Шаг 5 - Выполнение сборки

Наберите `make` в строке терминала, чтобы выполнить совершенную рабочую сборку русифицированной игры для ПК. Если есть ядра в процессоре, добавьте `-j$(nproc)`, где `$(nproc)` - количество ядер в процессоре, чтобы ускорить процесс сборки. Такие примеры приведены ниже:

```
make                          # Простое выполнение сборки
make -j$(nproc)               # Ускоренное выполнение сборки
make ENABLE_DX12=1            # Простое выполнение сборки, но требуется DirectX 12 для Windows
make ENABLE_DX12=1 -j$(nproc) # Ускоренное выполнение сборки, но требуется DirectX 12 для Windows
```

В результате сборки ваша игра для ПК будет находиться в каталоге `build/us_pc`.

Примечания:

- Для Windows есть и поддерживаемые графические компоненты: DirectX 11 (по умолчанию, требуется Windows Vista SP2 или новее) или DirectX 12 (требуется Windows 10 или новее), а для Linux - OpenGL.
- Если нужно выполнить сборку для ПК с поддержкой 60 FPS, выполните патч: `tools/apply_patch.sh enhancements/60fps.patch`, затем запустите сборку снова.

## Выполнение сборки игры для Linux с помощью [Docker](https://docker.com)

Прежде чем, как выполнить сборку игры для Linux с помощью Docker, установите пакеты `git` и `patch` и повторите шаги 2-4.2 [сверху](#шаг-2---клонирование-репозиторий).

### Шаг 1 - Создание образа сборки

После установки и запуска [Docker](https://docker.com) создайте образ сборки. Это нужно сделать только один раз.
```
docker build -t sm64 .
```

### Шаг 2 - Русификация

Только что показано на шаге 4.3 сверху, выполните сборку контента:
```
docker run --rm --mount type=bind,source="$(pwd)",destination=/sm64 sm64 \
bash build_content.sh
```

### Шаг 3 - Выполнение сборки

Готовьтесь к выполнению сборки игры:
```
docker run --rm --mount type=bind,source="$(pwd)",destination=/sm64 sm64 \
make -j$(nproc)
```

В результате сборки ваша игра для Linux будет находиться там: `build/us_pc/sm64.us`.

## Выполнение сборки игры для Nintendo 64 / iQue Player

### Windows

1. Запустите один из терминалов (Командная строка или Windows PowerShell) от имени администратора и установите подсистему Windows для Linux (WSL) и любой дистрибутив:
```
wsl --install <дистрибутив>
```
Примечание: `<дистрибутив>` должен быть `ubuntu`, `debian` и `kali-linux`. Если есть другие дистрибутивы, которые вам нужны в WSL, наберите `wsl --list --online`.

Важно: WSL требуется Windows 10 версия 1903 или новее для систем x64. После установки WSL вам потребуется перезагрузить компьютер и войти снова, чтобы продолжить.

2. Перейдите [в раздел](#linux-1) снизу и продолжайте следовать инструкцию по выполнению сборки.

### Linux

Есть 5 шагов, чтобы выполнить совершенную рабочую сборку русифицированной игры для N64!

#### Шаг 1 - Установка пакетов

К системе сборки предъявляются следующие требования к пакету:

* python3 >= 3.6
* gcc, g++ <= 13.2
* pkgconf
* capstone
* binutils-mips
* bsdextrautils

Для использования GCC вместо IDO:

* gcc-mips <= 13.2

Инструкции по установке пакетов приведены ниже:

##### Debian / Ubuntu

Установите пакеты:
```
sudo apt install git build-essential python3 pkgconf libcapstone-dev binutils-mips-linux-gnu bsdextrautils
```

Важно: перед установкой пакетов не забудьте обновить список пакетов, введя `sudo apt update`.

Примечание: Если вы хотите использовать GNU C Compiler (GCC) для выполнения сборки ROM, установите следующие дополнительные пакеты:
```
sudo apt install gcc-mips-linux-gnu
```

##### Arch Linux

1. Установите пакеты:
```
sudo pacman -S base-devel python capstone
```

Важно: перед установкой пакетов не забудьте обновить пакеты, введя `sudo pacman -Syu`.

2. Понизьте версию GCC до 13.2:
```
sudo pacman -U \
https://archive.archlinux.org/packages/g/gcc/gcc-13.2.1-6-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/g/gcc-libs/gcc-libs-13.2.1-6-x86_64.pkg.tar.zst
```

Важно: НЕ обновляйте GCC до версии 14 - выполнение сборки инструмента ARMIPS выдаёт ошибки. Для обновления других пакетов используйте `pacman -Syu --ignore gcc --ignore gcc-libs`

3. Установите следующие AUR-пакеты:

* [mips64-elf-binutils](https://aur.archlinux.org/packages/mips64-elf-binutils) (AUR)

Примечание: Если вы хотите использовать GNU C Compiler (GCC) для выполнения сборки ROM, установите следующие дополнительные пакеты:

1. [mips64-elf-gcc-stage1](https://aur.archlinux.org/packages/mips64-elf-gcc-stage1) (AUR)
2. [mips64-elf-newlib](https://aur.archlinux.org/packages/mips64-elf-newlib) (AUR)
3. [mips64-elf-gcc](https://aur.archlinux.org/packages/mips64-elf-gcc) (AUR)

##### Другие дистрибутивы

Большинство современных дистрибутивов Linux должны иметь пакеты, эквивалентные двум другим, перечисленным выше. Возможно, вам придется использовать другую версию GNU binutils (или gcc). Ниже перечислены полностью совместимые дистрибутивы binutils (или gcc), поддерживаемые makefile, и примеры дистрибутивов, которые их предлагают:

* `mips64-elf-` (Arch AUR)
* `mips-linux-gnu-` (Ubuntu и другие дистрибутивы, основанные на Debian)
* `mips64-linux-gnu-` (RHEL/CentOS/Fedora)

Вы также можете использовать [Docker](#docker) для установки образа с минимальными пакетами.

#### Шаг 2 - Клонирование репозиторий

1. Клонируйте основной репозиторий, где есть исходный код игры:
```
git clone https://github.com/sm64-port/sm64-port
```

2. Клонируйте дополнительный репозиторий, где есть русификация:
```
git clone https://github.com/AlexN-SM64/sm64-rus
```

#### Шаг 3 - Копирование в базовый РОМ для извлечения ассетов

Поставьте ТОЛЬКО оригинальную американскую (США) версию игры Super Mario 64 N64 ROM сюда и переименуйте в `baserom.us.z64` для извлечения ассетов.

Примечание: Этот базовый ROM должен совпадать SHA1: `9bef1128717f958171a4afac3ed78ee2bb4e86ce`. Наберите `sha1sum baserom.us.z64 && cat sm64.us.sha1` в строке терминала и проверьте, подходит ли для извлечения ассетов или нет.

#### Шаг 4 - Русификация

1. В проводнике находите каталог `sm64-rus`, скопируйте всё, кроме папки `.git`, и вставляйте в тот каталог репозитория, где есть исходный код игры, заменив файлы.

2. Измените `Makefile` с помощью патча:
```
tools/apply_patch.sh patch_makefile_rus_diff3.patch
```

3. Выполните сборку контента:
```
bash build_content.sh
```

#### Шаг 5 - Выполнение сборки

Наберите `make TARGET_N64=1` в строке терминала, чтобы выполнить совершенную рабочую сборку русифицированной игры для N64. Если есть ядра в процессоре, добавьте `-j$(nproc)`, где `$(nproc)` - количество ядер в процессоре, чтобы ускорить процесс сборки. Такие примеры приведены ниже:

```
make TARGET_N64=1                # Простое выполнение сборки
make TARGET_N64=1 -j$(nproc)     # Ускоренное выполнение сборки
make TARGET_N64=1 GRUCODE=f3dex  # Простое выполнение сборки с микрокодом Fast3DEX
make TARGET_N64=1 GRUCODE=f3dex2 # Простое выполнение сборки с микрокодом Fast3DEX2
make TARGET_N64=1 COMPILER=gcc   # Простое выполнение сборки с помощью GCC
```

В результате сборки ваша игра для N64 будет находиться там: `build/us/sm64.us.z64`.

Примечания:

- Для русификации установлены параметры сборки по умолчанию: Версия - США, Сравнить - НЕТ, Микрокод - Fast3DZEX.
- Если нужно выполнить сборку для китайской приставки iQue Player, выполните патч: `tools/apply_patch.sh enhancements/ique_support.patch`, затем запустите сборку снова.
- Если есть пакет `gcc-mips`, добавьте `COMPILER=gcc`, чтобы не тратить время выполнения сборки инструментов.
- После выполнения сборки игры для N64 с поддержкой микрокода Fast3DEX или Fast3DEX2, видеоплагин GlideN64 не поддерживает таких микрокодов.
- Выполнение сборки игры для N64 с поддержкой микрокода Fast3D OLD или Fast3D NEW практически НЕВОЗМОЖНО - игра столкнётся при создании любого нового файла (Марио А, Б, В и Г) в меню.
- И ПОСЛЕДНЕЕ! Выполнение сборки игры для N64 в Arch Linux НЕ ЗАВЕРШЕНО по-настоящему. Попробуйте использовать систему на основе Debian.

### Docker

Прежде чем, как выполнить сборку игры для N64 с помощью Docker, установите пакеты `gcc` и `patch` и повторите шаги 2-4.2 [сверху](#шаг-2---клонирование-репозиторий-1).

#### Шаг 1 - Создание образа сборки

После установки и запуска [Docker](https://docker.com) создайте образ сборки. Это нужно сделать только один раз.
```
docker build -t sm64 .
```

Примечание: Если вы хотите использовать GNU C Compiler (GCC) для выполнения сборки ROM, установите следующие дополнительные пакеты:
```
docker run --rm --mount type=bind,source="$(pwd)",destination=/sm64 sm64 \
apt-get install -y gcc-mips-linux-gnu
```

#### Шаг 2 - Русификация

Только что показано на шаге 4.3 сверху, выполните сборку контента:
```
docker run --rm --mount type=bind,source="$(pwd)",destination=/sm64 sm64 \
bash build_content.sh
```

#### Шаг 3 - Выполнение сборки

Готовьтесь к выполнению сборки игры:
```
docker run --rm --mount type=bind,source="$(pwd)",destination=/sm64 sm64 \
make TARGET_N64=1 -j$(nproc)
```

В результате сборки ваша игра для N64 будет находиться там: `build/us/sm64.us.z64`.

## Выполнение сборки игры для другой платформы (Android, PS4 и т.д.)

Прежде чем, как выполнить сборку русифицированной игры для другой платформы, давайте следим!

Сначала находите и клонируйте репозиторий, где есть исходный код игры для порта на другую платформу, и следите инструкцию! Затем перед сборкой русифицируйте пошагово:

1. Клонируйте дополнительный репозиторий, где есть русификация, ВНЕ основного:
```
pushd ..
git clone https://github.com/AlexN-SM64/sm64-rus
popd
```

2. В проводнике находите каталог `sm64-rus`, скопируйте всё, кроме папки `.git`, и вставляйте в тот каталог репозитория, где есть исходный код игры, заменив файлы.

3. Измените `Makefile` с помощью патча:
```
tools/apply_patch.sh patch_makefile_rus.patch
```

4. Выполните сборку контента:
```
bash build_content.sh
```

Русификация теперь готова. Можно выполнить сборку!
